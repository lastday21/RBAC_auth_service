# Схема управления доступом (RBAC) в проекте

Ниже описана структура управления доступом (RBAC), реализованная в сервисе.

---

## 1. Базовые сущности и таблицы

### **Role (роль)**
- Таблица: `roles`.
- Поля:
  - `id` — идентификатор роли.
  - `name` — уникальное имя роли.
  - `created_at` — дата создания.

### **UserRole (связь пользователь ↔ роль)**
- Таблица: `user_roles`.
- Назначение: many‑to‑many связь пользователей и ролей.
- Составной первичный ключ: (`user_id`, `role_id`).
- Внешние ключи:
  - `user_id` → `users.id`
  - `role_id` → `roles.id`

### **BusinessElement (защищаемый ресурс)**
- Таблица: `business_elements`.
- Назначение: описывает доменные объекты/ресурсы, к которым применяется доступ.
- Поля:
  - `code` — уникальный код ресурса (используется в проверках доступа).
  - `title` — человекочитаемое название.

### **AccessRoleRule (правила доступа роли к ресурсу)**
- Таблица: `access_roles_rules`.
- Назначение: связывает роль и ресурс, задаёт набор прав.
- Уникальная пара: (`role_id`, `element_id`).
- Набор булевых прав:
  - `read_permission` / `read_all_permission`
  - `create_permission`
  - `update_permission` / `update_all_permission`
  - `delete_permission` / `delete_all_permission`

> Различие между `*_permission` и `*_all_permission`:
> - `*_permission` — доступ только к объектам, владельцем которых является пользователь.
> - `*_all_permission` — доступ ко всем объектам ресурса.

---

## 2. Логика проверки прав

Проверка реализована в `app/core/rbac.py` и использует следующие шаги:

1. **Поиск ресурса**
   - По строковому коду (`resource`) находится запись в `business_elements`.

2. **Получение ролей пользователя**
   - Все роли пользователя берутся из `user_roles`.

3. **Поиск правил доступа**
   - Находятся все правила `access_roles_rules` для сочетания (роль + ресурс).

4. **Проверка действия**
   - Для `create` — достаточно `create_permission`.
   - Для `read`/`update`/`delete`:
     - Если есть `*_all_permission`, доступ разрешается.
     - Иначе доступ разрешается только если пользователь владелец ресурса (`owner_id == user.id`) и активирован флаг `*_permission`.

5. **Декораторы-зависимости FastAPI**
   - `require_permission(resource, action)` — обычная проверка.
   - `require_permission_with_owner(resource, action)` — проверка с учётом владельца.

---

## 3. Управление RBAC через API

В административном роутере `/admin` доступны CRUD‑операции:

- **Роли** (`/roles`) — создание/изменение/удаление ролей.
- **Ресурсы** (`/elements`) — создание/изменение/удаление элементов.
- **Правила доступа** (`/rules`) — настройка прав роли на ресурс.
- **Назначение ролей пользователям** (`/users/{user_id}/roles`).

Каждая операция защищена отдельными RBAC‑правами (`rbac_roles`, `rbac_rules`, `rbac_user_roles`).

---

## 4. Итоговая схема

```
User ──< UserRole >── Role ──< AccessRoleRule >── BusinessElement
```

- Пользователь получает права через роли.
- Роли получают права через правила на ресурсы.
- Для операций `read/update/delete` различаются доступы «только свои объекты» и «все объекты».

---

## 5. Пример на основе демо-сида и моковых ручек

В `seed_demo_data` создаются две роли и два пользователя:

- **Admin** (`admin` / `123`) с ролью `admin`.
- **User** (`user` / `123`) с ролью `user`.

### Назначения прав в демо-сиде

- Для роли **admin** включены все права (`read/create/update/delete` + `*_all`) на все элементы, включая `products` и `orders`.
- Для роли **user** включены права:
  - `read`, `create`, `update`, `delete` **без** флагов `*_all` на элементах `products` и `orders`.

Это значит:
- **admin** видит и изменяет *все* записи.
- **user** может читать/обновлять/удалять *только свои* записи (владение проверяется через `owner_id`).

### Как это проявляется на моковых ручках `/mock`

- **GET `/mock/products`**
  - `admin` получает список всех товаров (включая чужие).
  - `user` получает только товары с `owner_id == user.id`.
- **PATCH `/mock/products/{product_id}`**
  - `admin` может изменить любой товар.
  - `user` может изменить только свой товар.
- **GET `/mock/orders`**
  - `admin` получает все заказы.
  - `user` получает только свои заказы.

Таким образом, демо‑сид наглядно показывает отличие прав «свои объекты» (`*_permission`) и «все объекты» (`*_all_permission`) в работе мокового API.

Если для той же роли включить `read_all_permission = true`, то пользователь сможет читать **любые** заказы.
